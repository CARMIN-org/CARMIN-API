openapi: '3.0.0'
info:
  version: '0.2.2'
  title: CARMIN a Common web API for Remote pipeline INvocation
  description: FLI/IAM REST API for exchanging data and remote calling pipelines.
  license:
    name: MIT License
    url: https://opensource.org/licenses/MIT
  contact:
    name: CARMIN mailing list
    url: https://groups.google.com/d/forum/carmin
    email: carmin@googlegroups.com
security: 
- ApiKey: []
paths:
  /platform:
    get:
      summary: Returns information about the platform
      description: 
        https must be supported in the list of the supported protocols.
      operationId: getPlatformProperties
      security: []
      responses:
        '200':
          description: successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlatformProperties'
        default:
          $ref: '#/components/responses/Error'
  /authenticate:
    post:
      summary: Returns the api key necessary to use the API.
      description:
         The key can be dynamic (a new one for each request) or static (always the same one until the user change it in a back-end)
      operationId: authenticate
      security: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthenticationCredentials'
      responses:
        '200':
          description: successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Authentication'
        default:
            $ref: '#/components/responses/Error'
  /executions:
    get:
      summary: Lists some executions.
      description:
        list all execution Ids in the platform which are ordered in decreasing submission time.
        All the executions that were launched by the user must be returned. It is up to the platform to return executions that the user did not launch.
        When studyIdentifier is present, all the executions that the user launched in the study must be returned.
      operationId: listExecutions
      parameters:
      - name: studyIdentifier
        in: query
        schema:
          type: string
      - name: offset
        in: query
        schema:
          type: string
      - name: limit
        in: query
        schema:
          type: string
      responses:
        '200':
          description: successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Execution'
        default:
          $ref: '#/components/responses/Error'
    post:
      summary: Initializes an execution
      description:
        The successful response must contain the execution identifier. 
        If the status “Initializing” is returned, playExecution must be called to start the execution.
      operationId: createExecution
      requestBody :
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Execution'
      responses:
        '200':
          description: successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Execution'
        default:
          $ref: '#/components/responses/Error'
  /executions/count:
    get:
      summary: Give the number of the user's executions
      operationId: countExecutions
      parameters:
      - name: studyIdentifier
        in: query
        schema:
          type: string
      responses:
        '200':
          description: successful response
          content:
            text/plain:
              schema:
                type: integer
        default:
          $ref: '#/components/responses/Error'
  /executions/{executionIdentifier}:
    parameters:
    - $ref: '#/components/parameters/PathExecutionIdentifier'
    get:
      summary: get information about an execution
      operationId: getExecution
      responses:
        '200':
          description: successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Execution'
        default:
          $ref: '#/components/responses/Error'
    put:
      summary: Modify an execution. 
      description:
        Only the name and the timeout of the execution can be modified. 
        Changes to the identifier or the status will raise errors. 
        Changes to the other properties will be ignored.
      operationId: updateExecution
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Execution'
      responses:
        '204':
          description: successful response
        default:
          $ref: '#/components/responses/Error'
  /executions/{executionIdentifier}/results:
    get:
      summary: get the result files of the execution
      operationId: getExecutionResults
      parameters:
      - $ref: '#/components/parameters/PathExecutionIdentifier'
      - name: protocol
        in: query
        description: if not specified the default protocol is https
        schema:
          type: string
      responses:
        '200':
          description: successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Path'
        default:
          $ref: '#/components/responses/Error'
  /executions/{executionIdentifier}/stdout:
    get:
      summary: get stdout of an execution
      operationId: getStdout
      parameters:
      - $ref: '#/components/parameters/PathExecutionIdentifier'
      responses:
        '200':
          description: successful response
          content:
            text/plain:
              schema:
                type: string
        default:
          $ref: '#/components/responses/Error'
  /executions/{executionIdentifier}/stderr:
    get:
      summary: get stderr of an execution
      operationId: getStderr
      parameters:
      - $ref: '#/components/parameters/PathExecutionIdentifier'
      responses:
        '200':
          description: successful response
          content:
            text/plain:
              schema:
                type: string
        default:
          $ref: '#/components/responses/Error'
  /executions/{executionIdentifier}/play:
    put:
      summary: play an execution
      operationId: playExecution
      parameters:
      - $ref: '#/components/parameters/PathExecutionIdentifier'
      responses:
        '204':
          description: successful response
        default:
          $ref: '#/components/responses/Error'
  /executions/{executionIdentifier}/kill:
    put:
      summary: kill an execution
      operationId: killExecution
      parameters:
      - $ref: '#/components/parameters/PathExecutionIdentifier'
      responses:
        '204':
          description: successful response
        default:
          $ref: '#/components/responses/Error'
  /executions/{executionIdentifier}/delete:
    put:
      summary: Delete an execution
      description:
        This will kill the underlying processes (if possible) and free all resources associated with this execution (depending of the configuration given in as body input).
      operationId: deleteExecution
      parameters:
      - $ref: '#/components/parameters/PathExecutionIdentifier'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteExecutionConfiguration'
      responses:
        '204':
          description: successful response
        default:
          $ref: '#/components/responses/Error'
  /pipelines:
    get:
      summary: List pipelines
      description:
        All the pipelines that the user can execute must be returned.
        It is up to the platform to return pipelines that the user cannot execute.
        When studyIdentifier is present, all the pipelines that the user can execute in the study must be returned. In this case, execution rights denote the rights to execute the pipeline in the study.
      operationId: listPipelines
      parameters:
      - name: studyIdentifier
        in: query
        schema:
          type: string
          format: ascii
      responses:
        '200':
          description: successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Pipeline'
        default:
          $ref: '#/components/responses/Error'
  /pipelines/{pipelineIdentifier}:
    get:
      summary: Show the definition of a pipeline
      operationId: getPipeline
      parameters:
      - name: pipelineIdentifier
        in: path
        required: true
        schema:
          type: string
          format: ascii
      responses:
        '200':
          description: successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pipeline'
        default: 
          $ref: '#/components/responses/Error'      
  /path/{completePath}:
    get:
      summary: get content or various information
      description:
        Give access to multiple information about a specific path. 
        Depending on the optional action query parameter, different informations are available (see the parameter description). 
        More importantly, if the "action" parameter is absent, the raw file is returned. 
        If no "action" parameter is present and the path points to a directory, a tarball of this directory is returned.
      operationId: getPath
      parameters:
      - name: completePath
        in: path
        required: true
        description: the complete path on which to request information. 
          It can contain non-encoded slashes. 
          Except for the "exists" action, any request on a non-existing path should return an error
        schema:
          type: string
      - name: action
        in: query
        description:
          The action parameter must be one of [exists/properties/list/md5]. 
          The "exists" action produces a BooleanResponse (see definition) indicating if the path exists or no. 
          The "properties" action response produces a PathProperties (see definition) with the path properties. 
          The "list" action produces a DirectoryList (see definition) with all the files of the directory (if the path is not a directory an error must be returned). 
          The "md5" action is optional and produces a PathMd5 (see definition).
        schema:
          type: string  
      responses:
        '200':
          description: successful response. If there is no action, the raw file is returned, with the according mime type. 
            If there is an action, a json response a returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetPathResponse' 
            '*/*':
              schema:
                type: string
                format: binary
        default:
          $ref: '#/components/responses/Error' 
components:
  securitySchemes:
    ApiKey:
      type: apiKey
      name: apikey
      in: header
      description: An API key that must be provided by the platform.
  parameters:
    PathExecutionIdentifier:
      name: executionIdentifier
      in: path
      required: true   
      schema:
        type: string
        format: ascii
  responses:
    Error:
      description: An functional or internal error occured processing the request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorCodeAndMessage'
  schemas:
    ErrorCodeAndMessage:
      type: object
      required:
        - errorCode
        - errorMessage
      properties:
        errorCode:
          type: integer
          format: int64
        errorMessage:
          type: string
    PlatformProperties:
      type: object
      required:
        - supportedTransferProtocols
        - supportedModules
        - supportedAPIVersion
      properties:
        platformName: # not present in 0.2 version, keep it as optional
          type: string
          description: Name of the platform.
        APIErrorCodesAndMessages:
          type: array
          items:
            $ref: '#/components/schemas/ErrorCodeAndMessage'
        supportedTransferProtocols:
          type: array
          items:
            type: string
            enum: ["http", "https", "ftp", "sftp", "ftps", "scp", "webdav"]
          description:
            Protocol names must be URL prefixes (e.g. "http", "https", "ftp", "sftp", "ftps", "scp", "webdav"). 
        supportedModules:
          type: array
          items:
            type: string
            enum: ["Processing", "Data", "AdvancedData", "Management", "Commercial", ]
        defaultLimitListExecutions: # not present in 0.2, keep it as optional
          type: integer
          format: int64
          description: The number of Executions returned by getExecutions
        email:
          type: string
          format: email
        platformDescription:
          type: string
        minAuthorizedExecutionTimeout:
          type: integer
          format: int64
        maxAuthorizedExecutionTimeout:
          type: integer
          format: int64
          description: 0 or absent means no max timeout. max has to be greater or equal to the min.
        defaultExecutionTimeout:
          type: integer
          format: int64
        unsupportedMethods: 
        # not present in 0.2, keep it as optional
          type: array
          items:
            type: string
          description: List of optional methods that are not supported by the platform. Must be consistent with the "isKillExecutionSupported" property.
        defaultStudy:
          type: string
          format: ascii
        supportedAPIVersion:
          type: string
          format: ascii
      additionalProperties: true # allow extensions   
    AuthenticationCredentials:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
        password:
          type: string
    Authentication:
      type: object
      required:
        - httpHeader
        - httpHeaderValue
      properties:
        httpHeader:
          type: string
        httpHeaderValue:
          type: string
    Pipeline:
      type: object
      required:
        - identifier
        - name
        - version
        # - parameters optional in 0.2
      properties:
        identifier:
          type: string
          format: ascii
        name:
          type: string
        version:
          type: string
          format: ascii
        description:
          type: string
        canExecute:
          type: boolean
          description: true if the user who requested the pipeline can execute it
        parameters:
          type: array
          items:
            $ref: '#/components/schemas/PipelineParameter'
        errorCodesAndMessages:
          type: array
          items:
            $ref: '#/components/schemas/ErrorCodeAndMessage'
    PipelineParameter:
      type: object
      required:
        - name
        - type
        - isOptional
        - isReturnedValue
      properties:
        name:
          type: string
          format: ascii
        type:
          $ref: '#/components/schemas/ParameterType'
        isOptional:
          type: boolean
        isReturnedValue:
          type: boolean
        defaultValue:
          description: Default value. It must be consistent with the parameter type.
        description:
          type: string
    ParameterType:
      type: string
      enum: [File,String,Boolean,Int64,Double,List]
    Execution:
      type: object
      required:
        - name
        - pipelineIdentifier
        - inputValues
      properties:
        identifier:
          type: string
          format: ascii
          readOnly: true
          description: execution id. Must always be present in responses.
        name:
          type: string
          description: execution name
        pipelineIdentifier:
          type: string
          format: ascii
          description: which pipeline that started this execution
        timeout:
          type: integer
          format: int64
          description: The timeout in seconds until which the execution is killed and deleted with all its files. 0 or absense means no timeout
        status:
          type: string
          enum: [Initializing,Ready,Running,Finished,InitializationFailed,ExecutionFailed,Unknown,Killed]
          readOnly: true
          description: The status of the execution. Must always be present in responses.
        inputValues:
          type: object
          additionalProperties: true
          description:
            Represents the input as a key/value object. The types should respect the parameters of the pipeline used for the execution.
        returnedFiles:
          type: object
          additionalProperties:
            type: array
            items: 
              type: string
              format: url
          readOnly: true
          description: 
            Absent when not available (e.g. execution still running). Empty if no returned file is produced.
            Each key/value of the "returnedFiles" object corresponds to an output pipeline parameter (with "isReturnedValue" set to true) and the key must be the parameter name. The value must be an array of valid URL strings.
            A value array can be empty if the output parameter produces no value. It can have several URLs entries when the output is a directory with several files, a big file split in several download links, several files or any other implementation specific design.
        studyIdentifier:
          type: string
          format: ascii
        errorCode:
          type: integer
          format: int64
          readOnly: true
        startDate:
          type: integer
          format: int64
          description: Time in seconds since Unix epoch
          readOnly: true
        endDate:
          type: integer
          format: int64
          description: Time in seconds since Unix epoch
          readOnly: true
    DeleteExecutionConfiguration:
      type: object
      required: [deleteFiles]
      properties:
        deleteFiles:
          type: boolean
    GetPathResponse :
      oneOf:
      - $ref: '#/components/schemas/BooleanResponse'
      - $ref: '#/components/schemas/Path'
      - $ref: '#/components/schemas/DirectoryList'
      - $ref: '#/components/schemas/PathMD5'
    BooleanResponse:
      description: A boolean response for "exists" action "getPath" operation
      type: object
      properties:
        exists:
          type: boolean
      required:
      - exists
    DirectoryList:
      type: object
      properties:
        directories:
          type: array
          items:
            $ref: '#/components/schemas/Path'
      required:
      - directories
    PathMD5:
      type: object
      properties:
        md5:
          type: string
      required:
      - md5
    Path:
      type: object
      required:
      - platformPath
      - lastModificationDate
      - isDirectory
      properties:
        platformPath:
          type: string
          description: A valid path, slash-separated. It must be consistent with the path of files and directories uploaded and downloaded by clients. For instance, if a user uploads a directory structure "dir/{file1.txt,file2.txt}", it is expected that the path of the first file will be "[prefix]/dir/file1.txt" and that the path of the second file will be "[prefix]/dir/file2.txt" where [prefix] depends on the upload parameters, in particular destination directory.
        lastModificationDate:
          type: integer
          format: int64
          description: Date of last modification, in seconds since the Epoch (UNIX timestamp).
        isDirectory:
          type: boolean
          description: True if the path represents a directory.
        size:
          type: integer
          format: int64
          description: For a file, size in bytes. For a directory, sum of all the sizes of the files contained in the directory (recursively).
        executionId:
          type: string
          format: ascii
          description: Id of the Execution that produced the Path.
        mimeType:
          type: string
          format: ascii
          description: mime type based on RFC 6838.